<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마스크 내놔</title>
    
    <link rel="stylesheet" th:href="@{/lib/jui/dist/ui.min.css}" />
    <link rel="stylesheet" th:href="@{/lib/jui/dist/ui-jennifer.min.css}" />
    <link rel="stylesheet" th:href="@{/lib/jui-grid/dist/grid-jennifer.css}" />
    <link th:href="@{/webjars/bootstrap/4.4.1/css/bootstrap.min.css}" rel="stylesheet"></link>
    <script th:src="@{/webjars/bootstrap/4.4.1/js/bootstrap.min.js}"></script>
    <script th:src="@{/webjars/jquery/2.1.3/dist/jquery.min.js}"></script>
    <script th:src="@{/lib/jui-core/dist/core.min.js}"></script>
    <script th:src="@{/lib/jui/dist/ui.min.js}"></script>
    <script th:src="@{/lib/jui-grid/dist/grid.js}"></script>
    
    <style>
        .button-height {
            height: auto;
        }
    </style>
</head>
<body>
    <div id="notice" style="text-align: center">
        <h1> 공지사항 </h1>
        <p class="lead">
            1. 이번 주는 서비스의 안정적 운영을 지켜보기 위하여 베타서비스 입니다.
            <br />
            2. 서비스되는 재고 현황 정보는 데이터 처리 및 전송으로 인해 실제 현장 판매처의
            현황과  <font size="6pt"><b>5분~10분 정도의 차이</b></font>가 있습니다.
            <br />
            3. 일부 약국에서는 번호표 배부 후 판매하는 약국도 있어 서비스되는
            정보가 번호표 배부 현황을 반영하지는 못하고 있습니다.
            <br />
            4. 마스크 현황 정보는 성인용 마스크를 대상으로 합니다.
            <br />
            5. 마스크 재고 현황은 국민들의 혼돈을 방지하기 위해 4단계 구간 정보로 제공됩니다.  <br /> 
            - 100개 이상 : 충분 * <font color="greenyellow"> 녹색 </font> <br />
            - 100개 미만(99개~30개) : 보통 * <font color="yellow"> 노랑색 </font> <br />
            - 30개 미만(29개~2개) : 부족 * <font color="red"> 빨강색 </font> <br />
            - 1개~0개 : 없음 또는 판매전 : * <font color="gray">회색 </font>
            <br />
            6. 마스크 판매정보 수집DB 안정화 등 작업으로 인해 매일 갱신되는
            정보는 08:00~23:00까지 운영됩니다.
            <br />
            7. 식약처 공적마스크 구매 안내 :
            <a href="http://blog.naver.com/kfdazzang/221839489769">http://blog.naver.com/kfdazzang/221839489769 </a>
            <br />
            8. 데이터 출처는 심평원‧정보화진흥원(공공데이터포털)
            데이터 공개 문의는 한국정보화진흥원 : <a href="maskdata@nia.or.kr">maskdata@nia.or.kr</a>
            <br />
            9. 어려운 환경에서도 일선에서 공헌해 주시는 약사님, 우체국 종사자분, 하나로 마트(예정) 분들께도 감사와 응원 드립니다.
        </p>
    </div>
    
    <div id="content" style="text-align: center">
        <button type="button" onclick="sample6_execDaumPostcode()" class="btn btn-info button-height" > 우편번호 찾기 </button><br />
        <input type="hidden" name="extraAddress" placeholder="참고항목">
        
        <br />
        <div style="margin-bottom: 1rem;">
            <label th:text="주소"></label>
            <input type="text" name="address" class="form-control" style="width:50%; display: initial; text-align: center" />
            <button id="button" onclick="search()" class="btn btn-info button-height" >검색</button>
        </div>
    </div>

    <div id="table">
        <table id="table_8" class="table classic">
            <thead>
            <tr>
                <th width="50px">No</th>
                <th th:text="이름"> 단어</th>
                <th th:text="주소">뜻</th>
                <th th:text="갯수">다음 시험 일자</th>
                <th th:text="입고시간">다음 시험 일자</th>
                <th th:text="업데이트시간">다음 시험 일자</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script id="tpl_row" data-jui="#table_8" data-tpl="row" type="text/template">
        <tr style="cursor: pointer;">
            <td><!= row.index !></td>
            <td><!= name !></td>
            <td><!= addr !></td>
            <td name="remain"><!= remain_stat !></td>
            <td><!= stock_at !></td>
            <td><!= created_at !></td>
        </tr>
    </script>
    
    <script th:inline="javascript">
    
        window.onload = function(){
            drawGrid();
        }
        
        document.querySelector("input[name=address]").addEventListener("keydown", key => {
            if (key.keyCode == 13) {
            	search();
            }
        });
        
        function search() {
            let data = {
                    address : document.querySelector("input[name=address]").value
                    , extraAddress : document.querySelector("input[name=extraAddress]").value
            }

            $.ajax({
                type:"GET"
                , url: "/test"
                , data: data
                , contentType: "application/json"
                , dataType : 'JSON'
                , cache: false
                , async: false
                , success: function(data) {
                    drawGrid(data);
                }
            });
            
            setColor();
        }
        
        function drawGrid(data) {
            jui.ready([ "grid.table" ], function(table) {
                table_8 = table("#table_8", {
                    fields: [ null, "name", "addr", "remain_stat", "stock_at", "created_at"],
                    data: data,
                    resize: true,
                    sort: true,
                    event: {
                        sort: function(column, e) {
                            setColor();
                        }
                    },
                    tpl: {
                        row: $("#tpl_row").html()
                    }
                });
            });
        }
        
        function setColor() {
            const remains = document.getElementsByName("remain");
            remains.forEach(function(remain) {
                if (remain.innerHTML === "3") {
                    remain.innerHTML = "<b> 없음 </b>";
                    remain.style.backgroundColor = "gray";
                } else if (remain.innerHTML === "2") {
                    remain.innerHTML = "<b> 부족 (29개 ~ 2개) </b>";
                    remain.style.backgroundColor = "red";
                } else if (remain.innerHTML === "1") {
                    remain.innerHTML = "<b> 보통 (99개 ~ 30개)</b>";
                    remain.style.backgroundColor = "yellow";
                } else if (remain.innerHTML === "0") {
                    remain.innerHTML = "<b> 충분 (100개 이상) </b>";
                    remain.style.backgroundColor = "greenyellow";
                }
            });
        }
        
        function sample6_execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                    var addr = ''; // 주소 변수
                    var extraAddr = ''; // 참고항목 변수
                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.roadAddress;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.jibunAddress;
                    }
                    
                    // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                    if(data.userSelectedType === 'R'){
                        // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                        // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        
                        // 조합된 참고항목을 해당 필드에 넣는다.
                        document.querySelector("input[name=extraAddress]").value = extraAddr;
                    
                    } else {
                    	document.querySelector("input[name=extraAddress]").value = '';
                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.querySelector("input[name=address]").value = addr;
                    search();
                }
            }).open();
           }
        
    </script>
</body>
</html>